---
import { MessageCircle, X, Sparkles } from "lucide-react";
---

<div class="fixed right-6 bottom-6 z-50 flex flex-col items-end gap-4">
    <!-- AI Message Bubble -->
    <div
        id="ai-bubble"
        class="bg-white px-5 py-3 rounded-2xl shadow-2xl border border-gray-100 max-w-[240px] hidden opacity-0 translate-y-4 transition-all duration-500 relative group cursor-pointer hover:border-primary/30"
    >
        <button
            id="close-bubble"
            class="absolute -top-2 -right-2 bg-white shadow-md rounded-full p-1 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity z-20"
            aria-label="Tutup pesan"
        >
            <X className="w-3 h-3 text-gray-400" />
        </button>
        <p id="ai-message" class="text-sm font-medium text-dark leading-snug">
            Butuh bantuan menghitung estimasi biaya pendaftaran?
        </p>
        <div
            class="absolute -bottom-1.5 right-6 w-3 h-3 bg-white border-r border-b border-gray-100 rotate-45"
        >
        </div>
    </div>

    <!-- Main Button -->
    <button
        id="assistant-trigger"
        class="w-16 h-16 bg-primary rounded-full shadow-[0_10px_30px_rgba(15,81,50,0.3)] flex items-center justify-center text-accent hover:scale-110 active:scale-95 transition-all group relative overflow-hidden"
    >
        <div
            class="absolute inset-0 bg-gradient-to-tr from-primary via-primary to-accent/20 opacity-0 group-hover:opacity-100 transition-opacity"
        >
        </div>
        <Sparkles
            id="sparkle-icon"
            className="w-8 h-8 relative z-10 animate-pulse pointer-events-none"
        />
        <MessageCircle
            id="message-icon"
            className="w-8 h-8 relative z-10 hidden pointer-events-none"
        />
        <span
            class="absolute inset-0 rounded-full border-4 border-primary/30 animate-ping"
        ></span>
    </button>
</div>

<script>
    const bubble = document.getElementById("ai-bubble");
    const messageText = document.getElementById("ai-message");
    const closeBtn = document.getElementById("close-bubble");
    const trigger = document.getElementById("assistant-trigger");
    const sparkleIcon = document.getElementById("sparkle-icon");
    const messageIcon = document.getElementById("message-icon");

    const messages = [
        "Butuh bantuan menghitung estimasi biaya pendaftaran?",
        "Lihat paket umroh hemat hari ini?",
        "Tanyakan apa saja tentang syarat paspor di sini.",
        "Mau konsultasi gratis dengan pembimbing kami?",
    ];

    let currentMsgIndex = 0;

    function showBubble() {
        if (!bubble || !messageText) return;
        messageText.textContent = messages[currentMsgIndex];
        bubble.classList.remove("hidden");
        setTimeout(() => {
            bubble.classList.remove("opacity-0", "translate-y-4");
        }, 10);
        currentMsgIndex = (currentMsgIndex + 1) % messages.length;
    }

    function hideBubble() {
        if (!bubble) return;
        bubble.classList.add("opacity-0", "translate-y-4");
        setTimeout(() => {
            bubble.classList.add("hidden");
        }, 500);
    }

    function openSearch() {
        if (typeof (window as any).toggleSearch === "function") {
            (window as any).toggleSearch();
        } else {
            // Fallback if SearchOverlay isn't fully ready
            const overlay = document.getElementById("search-overlay");
            if (overlay) {
                overlay.classList.remove("hidden");
                setTimeout(() => overlay.classList.remove("opacity-0"), 10);
            }
        }
    }

    // Toggle icons
    setInterval(() => {
        sparkleIcon?.classList.toggle("hidden");
        messageIcon?.classList.toggle("hidden");
    }, 3000);

    // Initial show
    setTimeout(showBubble, 2000);

    // Periodic show
    setInterval(() => {
        if (bubble?.classList.contains("hidden")) showBubble();
    }, 15000);

    closeBtn?.addEventListener("click", (e) => {
        e.stopPropagation();
        hideBubble();
    });

    bubble?.addEventListener("click", () => {
        openSearch();
        hideBubble();
    });

    trigger?.addEventListener("click", openSearch);
</script>
